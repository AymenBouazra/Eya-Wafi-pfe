<app-header-body title="Gestion des offres de travail"></app-header-body>

<div class="container-fluid mt--7" style="height: calc(100vh - 80px);" *ngIf="jobs || jobs.length > 0">
 <div class="row h-100">
  <!-- Sidebar: Opportunities List -->
  <div class="col-lg-4 col-12 h-100" *ngIf="!showDetails || screenWidth >= 992">
   <div class="card shadow h-100">
    <div class="card-header border-0 d-flex justify-content-between align-items-center">
     <h3 class="mb-0">
      <i class="fa fa-briefcase text-purple text-md" aria-hidden="true"></i>
      Opportunités
     </h3>
    </div>
    <div class="card-body p-0 overflow-auto" style="max-height: calc(100vh - 200px);">
     <ul class="list-group list-group-flush">
      <li *ngFor="let job of jobs" class="list-group-item list-group-item-action"
       [class.active]="selectedJob?._id === job._id" (click)="selectJob(job)" style="cursor:pointer;">
       <div class="d-flex align-items-center">
        <i class="fa fa-briefcase text-secondary mr-2"></i>
        <span>{{ job.title }} <span class="font-weight-bold badge badge-warning" *ngIf="employeeApplicationsList.includes(job._id)">Déjà postulé</span></span>
       </div>
       <small class="badge badge-pill badge-info px-3 py-2 mt-2" [class]="{'text-white':selectedJob?._id === job._id}">
        <i class="fa fa-building mr-1"></i> {{ job.departement }}
       </small>
      </li>
     </ul>
    </div>
   </div>
  </div>

  <!-- Job Details -->
  <div class="col-lg-8 col-12 min-h-100 mb-3" *ngIf="showDetails || screenWidth >= 992">
   <div class="card shadow h-100">
    <div class="card-body">
     <ng-container *ngIf="selectedJob; else selectPrompt">
      <div class="d-flex justify-content-between align-items-center">
       <div class="d-flex justify-content-between align-items-center w-100">
        <h2 class="card-title text-primary mb-3">{{ selectedJob.title }}</h2>
        <button class="btn btn-lg btn-primary" [disabled]="employeeApplicationsList.includes(selectedJob._id)" (click)="openModal()">
         <i class="fa fa-paper-plane mr-2"></i>{{ employeeApplicationsList.includes(selectedJob._id) ? 'Déjà postulé' : 'Postuler' }}
        </button>
       </div>
       <button class="btn btn-outline-secondary d-lg-none" (click)="showDetails = false">
        <i class="fa fa-arrow-left"></i> Retour
       </button>
      </div>
      <div class="mb-2">
       <span class="badge badge-pill badge-info px-3 py-2">
        <i class="fa fa-building mr-1"></i> {{ selectedJob.departement }}
       </span>
      </div>
      <p class="mt-3"><strong>Description :</strong></p>
      <p class="text-muted" style="white-space: pre-line;">{{ selectedJob.description }}</p>
      <div class="mt-4">
       <strong>Compétences requises :</strong>
       <div class="mt-2">
        <span *ngFor="let skill of selectedJob.requiredSkills"
         class="badge badge-pill badge-success mr-2 mb-2 px-3 py-2">
         <i class="fa fa-check mr-1"></i> {{ skill.title || skill }}
        </span>
       </div>
      </div>
      <div class="mt-4 text-right">
       <button class="btn btn-lg btn-primary" [disabled]="employeeApplicationsList.includes(selectedJob._id)" (click)="openModal()">
        <i class="fa fa-paper-plane mr-2"></i>{{ employeeApplicationsList.includes(selectedJob._id) ? 'Déjà postulé' : 'Postuler' }}
       </button>
      </div>
     </ng-container>
     <ng-template #selectPrompt>
      <div class="d-flex align-items-center justify-content-center h-100">
       <span class="text-muted">Sélectionnez une offre de travail dans la liste à gauche.</span>
      </div>
     </ng-template>
    </div>
   </div>
  </div>
 </div>
</div>

<div *ngIf="!jobs || jobs.length === 0" class="container-fluid mt--7" style="height: calc(100vh - 50vh);">
 <div class="card shadow h-100 flex justify-content-center align-items-center">
  <span class="text-muted">Aucune offre d'emploi disponible.</span>
 </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" *ngIf="showModal"></div>
<div class="modal fade show d-block" tabindex="-1" *ngIf="showModal">
 <div class="modal-dialog modal-dialog-centered">
  <form [formGroup]="applyForm" (ngSubmit)="onSubmit()" class="modal-content">
   <div class="modal-header">
    <h5 class="modal-title text-primary">Postuler à <span class="font-weight-bold">{{ selectedJob?.title }}</span></h5>
    <button type="button" class="close" (click)="closeModal()">&times;</button>
   </div>
   <div class="modal-body">
    <div class="form-group">
     <label for="motivation">Motivation <span class="text-danger">*</span></label>
     <textarea id="motivation" formControlName="motivation" class="form-control" rows="4"
      placeholder="Expliquez pourquoi vous postulez..."></textarea>
     <div *ngIf="applyForm.get('motivation').invalid && applyForm.get('motivation').touched" class="text-danger mt-1">
      La motivation est requise.
     </div>
    </div>
   </div>
   <div class="modal-footer">
    <button type="submit" class="btn btn-success" [disabled]="isSubmitting || applyForm.invalid">
     {{ isSubmitting ? 'Envoi...' : 'Envoyer la candidature' }}
    </button>
    <button type="button" class="btn btn-secondary" (click)="closeModal()">Annuler</button>
   </div>
  </form>
 </div>
</div>